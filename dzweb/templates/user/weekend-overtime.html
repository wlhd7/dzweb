{% extends 'user/main.html' %}

{% block head %}
	{{ super() }}
	<link rel="stylesheet" href="{{ url_for('static', filename='css/weekend-overtime.css') }}">
{% endblock %}

{% block title %}周末加班单{% endblock %}

{% block user %}
<form method="post" class="user-title-end">
	<label for="department">请选择部门</label>
	<select name="department">
		<option value="manu" {% if department == 'manu' %}selected{% endif %}>制造</option>
		<option value="qual" {% if department == 'qual' %}selected{% endif %}>品质</option>
		<option value="craf" {% if department == 'craf' %}selected{% endif %}>工艺</option>
		<option value="asse" {% if department == 'asse' %}selected{% endif %}>装配</option>
		<option value="elec" {% if department == 'elec' %}selected{% endif %}>电气</option>
		<option value="tech" {% if department == 'tech' %}selected{% endif %}>技术</option>
		<option value="mach" {% if department == 'mach' %}selected{% endif %}>机加</option>
		<option value="buss" {% if department == 'buss' %}selected{% endif %}>业务</option>
	</select>
	<button type="submit" name="action" value="department">确定</button>
</form>

<form method="post">
	<label for="name">名字</label>
	<input name="name" required>

	{% if department == 'manu' %}
		<label for="sub-department">班组</label>
		<select name="sub-department" required>
			<option value="a">铣床</option>
			<option value="b">车床</option>
			<option value="c">CNC</option>
			<option value="d">磨床</option>
			<option value="e">线割</option>
			<option value="f">钳工</option>
			<option value="g">生管</option>
		</select>
	{% endif %}

	<button type="submit" name="action" value="add">新增</button>
	<button type="submit" name="action" value="delete">删除</button>
</form>



<form>
	<div class='day-control'>
		<div class="day" id="day">{{ current_date }}</div>
		{% if use_fallback_date %}
               		<span style="color: orange; font-size: 0.8em;">(显示前第七天数据)</span>
            	{% endif %}
		<a href="{{ url_for('user.weekend_overtime', date=prev_date) }}" class="steelblue link">上一天</a>
		<a href="{{ url_for('user.weekend_overtime', date=next_date) }}" class="steelblue link">下一天</a>
		<p><span class="red">提示：</span>每一天提交（确定）一次。<span class="bg-2">浅黄色</span>为公司内加班。 <span class="bg-3">浅蓝色</span>为出差。</p>
	</div>

	<div class="day-block">
		{% if department == 'manu' %}
			<p>铣床</p>
			<div id='a'></div>
			<p>车床</p>
			<div id='b'></div>
			<p>CNC</p>
			<div id='c'></div>
			<p>磨床</p>
			<div id='d'></div>
			<p>线割</p>
			<div id='e'></div>
			<p>钳工</p>
			<div id='f'></div>
			<p>生管</p>
			<div id='g'></div>
		{% else %}
			<div class="staffs-block" id="staffs-block"></div>
		{% endif %}
	</div>

	{% if use_fallback_date %}
        <div style="color: orange; margin: 10px 0;">
            提示：当前日期没有加班记录，显示前第七天({{ fallback_date }})的数据
        </div>
	{% endif %}
	<button onclick="saveStaffStatus()" type="button">确定</button>
</form>


<script>
	function saveStaffStatus() {
		const staffItems = document.querySelectorAll('.staff-item')
		const staffData = []

		staffItems.forEach(item => {
			let status = 'bg-1'
			if (item.classList.contains('bg-2')) {
				status = 'bg-2'
			} else if (item.classList.contains('bg-3')) {
				status = 'bg-3'
			}

			staffData.push({
				name: item.textContent.trim(),
				department: '{{ department }}',
				date: '{{ current_date }}',
				status: status 
			})
		})

		fetch('{{ url_for("user.weekend_overtime") }}', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				action: 'add-date',
				staffs: staffData,
				date: '{{ current_date }}'
			})
		})
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				alert('保存成功')
			} else {
				alert('保存失败')
			}
		})
		.catch(error => {
			console.error('Error:', error);
			alert('保存失败')
		})
	}

	{% if department == 'manu' %}
		const containers = {
			'a': document.getElementById('a'),
			'b': document.getElementById('b'),
			'c': document.getElementById('c'),
			'd': document.getElementById('d'),
			'e': document.getElementById('e'),
			'f': document.getElementById('f'),
			'g': document.getElementById('g'),
		}

		for (let container in containers) {
			containers[container].className = 'staffs-block'
		}

		{% for staff in staffs %}
			{	
				let subDept = "{{ staff['sub_department'] }}"
				let targetContainer = containers[subDept] || containers['g']
				let staffElement = document.createElement('div')
				staffElement.textContent = "{{ staff['name'] }}"
				staffElement.className = 'staff-item {{ staff["current_status"] or "bg-1" }}'
				staffElement.addEventListener('click', () => {
					if (staffElement.classList.contains('bg-1')) {
						staffElement.classList.remove('bg-1')
						staffElement.classList.add('bg-2')
					} else if (staffElement.classList.contains('bg-2')) {
						staffElement.classList.remove('bg-2')
						staffElement.classList.add('bg-3')
					} else if (staffElement.classList.contains('bg-3')) {
						staffElement.classList.remove('bg-3')
						staffElement.classList.add('bg-1')
					}

				})
				
				targetContainer.appendChild(staffElement)
			}
		{% endfor %}
	{% else %}
		const container = document.getElementById('staffs-block')
		
		{% for staff in staffs %}
			{
				let staffElement = document.createElement('div')
				staffElement.textContent = "{{ staff['name'] }}"
				staffElement.className = 'staff-item {{ staff["current_status"] or "bg-1" }}'
				staffElement.addEventListener('click', () => {
					if (staffElement.classList.contains('bg-1')) {
						staffElement.classList.remove('bg-1')
						staffElement.classList.add('bg-2')
					} else if (staffElement.classList.contains('bg-2')) {
						staffElement.classList.remove('bg-2')
						staffElement.classList.add('bg-3')
					} else if (staffElement.classList.contains('bg-3')) {
						staffElement.classList.remove('bg-3')
						staffElement.classList.add('bg-1')
					}

				})
				container.appendChild(staffElement)
			}
		{% endfor %}
	{% endif %}
</script>
{% endblock %}
	
